import re

from wazuh_testing.modules import vulnerability_detector as vd
from wazuh_testing.db_interface.cve_db import get_provider_feeds_number
from wazuh_testing.tools import LOG_FILE_PATH, ALERT_FILE_PATH
from wazuh_testing.tools.monitoring import FileMonitor


def make_vuln_callback(pattern, prefix=vd.VULNERABILITY_DETECTOR_PREFIX):
    """Create a callback function from a text pattern.

    It already contains the vulnerability-detector prefix.

    Args:
        pattern (str): String to match on the log.
        prefix (str): regular expression used as prefix before the pattern.

    Returns:
        lambda: function that returns if there's a match in the file

    Examples:
        >>> callback_bionic_update_started = make_vuln_callback("Starting Ubuntu Bionic database update")
    """
    pattern = r'\s+'.join(pattern.split())
    regex = re.compile(r'{}{}'.format(prefix, pattern))

    return lambda line: regex.match(line) is not None


def callback_detect_vulnerability_scan_sleeping(line):
    msg = rf"{vd.VULNERABILITY_DETECTOR_PREFIX} Sleeping for (.*)..."
    match = re.match(msg, line)

    return match.group(1) if match is not None else ""


def check_vuln_detector_event(wazuh_log_monitor=None, callback='', error_message=None, update_position=True,
                              timeout=vd.VULN_DETECTOR_EXTENDED_GLOBAL_TIMEOUT,
                              prefix=vd.VULNERABILITY_DETECTOR_PREFIX, accum_results=1):
    """Check if a vulnerability event occurs

    Args:
        wazuh_log_monitor (FileMonitor): FileMonitor object to monitor the Wazuh log
        callback (str): log regex to check in Wazuh log
        error_message (str): error message to show in case of expected event does not occur
        update_position (boolean): filter configuration parameter to search in Wazuh log
        timeout (str): timeout to check the event in Wazuh log
        prefix (str): log pattern regex
        accum_results (int): Accumulation of matches.
    """
    wazuh_log_monitor = FileMonitor(LOG_FILE_PATH) if wazuh_log_monitor is None else wazuh_log_monitor
    error_message = f"Could not find this event in {LOG_FILE_PATH}: {callback}" if error_message is None else \
        error_message

    wazuh_log_monitor.start(timeout=timeout, update_position=update_position, accum_results=accum_results,
                            callback=make_vuln_callback(callback, prefix), error_message=error_message)


def check_vulnerability_detector_disabled():
    """Check if the vulnerability detector module is disabled"""
    check_vuln_detector_event(callback='DEBUG: Module disabled. Exiting...', timeout=vd.VULN_DETECTOR_MEDIUM_TIMEOUT)


def check_provider_vulnerabilities_number(expected_number):
    """Check if the number of vulnerabilities inserted in VULNERABILITIES table of CVE DB is the expected.

    Args:
        expected_number (int): number of expected vulnerabilities
    """
    vulnerabilities_number = get_provider_feeds_number()
    assert vulnerabilities_number == expected_number, f"Number of inserted vulnerabilities is not the expected." \
                                                      f" Expected: {expected_number}, Got: {vulnerabilities_number}"


def check_log_event(wazuh_log_monitor, log_event, update_position=False,
                    timeout=vd.VULN_DETECTOR_EXTENDED_GLOBAL_TIMEOUT, prefix=vd.VULNERABILITY_DETECTOR_PREFIX):
    """Check if the vulnerable package has been reported.

    Args:
        wazuh_log_monitor (FileMonitor): FileMonitor object to monitor the Wazuh log
        log_event (str): Log event to find in ossec.log
        update_position (boolean): Filter configuration parameter to search in Wazuh log
        timeout (str): Timeout to check the event in Wazuh log
        prefix (str): Log pattern regex
    """
    check_vuln_detector_event(wazuh_log_monitor=wazuh_log_monitor, update_position=update_position, timeout=timeout,
                              callback=log_event, error_message=f"Could not find the log event: {log_event}",
                              prefix=prefix)


def check_feed_imported_successfully(wazuh_log_monitor, log_system_name, expected_vulnerabilities_number,
                                     update_position=False, timeout=vd.VULN_DETECTOR_EXTENDED_GLOBAL_TIMEOUT,
                                     check_vuln_number=True):
    """Check that redhat OVAL feeds have been imported successfully.

    Args:
        wazuh_log_monitor (FileMonitor): FileMonitor object to monitor the Wazuh log
        log_system_name (str): system name in ossec.log. For instance 'Red Hat Enterprise Linux'
        expected_vulnerabilities_number (int): number of expected vulnerabilities imported in the BD
        update_position (boolean): filter configuration parameter to search in Wazuh log
        timeout (str): timeout to check the event in Wazuh log
        check_vuln_number (bool): boolean to enable the check that compares the number of generated alerts with
                                  the number of expected alerts
    """
    check_vuln_detector_event(
        wazuh_log_monitor=wazuh_log_monitor, update_position=update_position, timeout=timeout,
        callback=rf"INFO: \(\d+\): The update of the '{log_system_name}' feed finished successfully.",
        error_message=f"Could not find the message: '{log_system_name}' feed finished successfully"
    )

    if check_vuln_number:
        check_provider_vulnerabilities_number(expected_number=expected_vulnerabilities_number)


def check_failure_when_importing_feed(wazuh_log_monitor, expected_vulnerabilities_number=0, update_position=False,
                                      timeout=vd.VULN_DETECTOR_EXTENDED_GLOBAL_TIMEOUT, parser_error=False):
    """Check an error message when importing redhat OVAL feeds and checks that the vulnerabilities table is empty

    Args:
        wazuh_log_monitor (FileMonitor): FileMonitor object to monitor the Wazuh log
        expected_vulnerabilities_number (int): number of expected vulnerabilities imported in the BD
        update_position (bool): filter configuration parameter to search in Wazuh log
        timeout (str): timeout to check the event in Wazuh log
        parser_error (bool): check if there is a parser error message
    """
    if parser_error:
        check_log_event(wazuh_log_monitor=wazuh_log_monitor, update_position=update_position, timeout=timeout,
                        log_event=r"ERROR: \(\d+\): The .* feed couldn't be parsed from .* file")

    check_log_event(wazuh_log_monitor=wazuh_log_monitor, update_position=update_position, timeout=timeout,
                    log_event=r"ERROR: \(\d+\): CVE database could not be updated.")

    check_provider_vulnerabilities_number(expected_number=expected_vulnerabilities_number)


def check_detected_vulnerabilities_number(wazuh_log_monitor, expected_vulnerabilities_number, feed_source, agent=None,
                                          update_position=False, timeout=vd.VULN_DETECTOR_GLOBAL_TIMEOUT):
    """Check the number of vulnerabilities found by the feed source.

    Args:
        wazuh_log_monitor (FileMonitor): FileMonitor object to monitor the Wazuh log
        expected_vulnerabilities_number (int): number of expected vulnerabilities
        feed_source (str): OVAL or NVD
        agent (str, optional): Agent id
        update_position (bool): filter configuration parameter to search in Wazuh log
        timeout (str): timeout to check the event in Wazuh log
    """
    callback = f"The {feed_source} found a total of '{expected_vulnerabilities_number}' " \
               "potential vulnerabilities for agent .* "
    if agent is not None:
        callback = f"The {feed_source} found a total of '{expected_vulnerabilities_number}' " \
                   f"potential vulnerabilities for agent '{agent}' "
    check_vuln_detector_event(wazuh_log_monitor=wazuh_log_monitor, update_position=update_position, timeout=timeout,
                              callback=callback, error_message=f"The expected number of {feed_source} vulnerabilities "
                                                               f"have not been found")


def check_feed_uncompressed_successfully(wazuh_log_monitor, feed, update_position=False,
                                         timeout=vd.VULN_DETECTOR_EXTENDED_GLOBAL_TIMEOUT):
    """Check that a feed from path or url have been uncompressed successfully

    Args:
        wazuh_log_monitor (FileMonitor): FileMonitor object to monitor the Wazuh log
        feed (str): Path or url where the feed is
        update_position (boolean): Filter configuration parameter to search in Wazuh log
        timeout (str): Timeout to check the event in Wazuh log
    """
    feed = feed[:-1] if feed[-1] == '$' else feed

    prefix = r'.*wazuh-modulesd.*'
    check_vuln_detector_event(wazuh_log_monitor=wazuh_log_monitor, update_position=update_position, timeout=timeout,
                              callback=rf"(The file|File from URL) '{feed}' was successfully uncompressed into .*",
                              error_message=f"Could not find the message: '{feed}' was successfully uncompressed",
                              prefix=prefix)


def check_vulnerability_scan_log(wazuh_log_monitor=None, package=None, cve=None):
    """Check if inserted vulnerable packages are reported by vulnerability detector.

    Args:
        wazuh_log_monitor (FileMonitor): FileMonitor object to monitor the Wazuh log
        package (str): Name of custom package to check. Example: 'firefox-0'
        cve (str): Package CVE. Example: 'CVE-2019-11764'
    """
    check_vuln_detector_event(wazuh_log_monitor=wazuh_log_monitor,
                              timeout=vd.VULN_DETECTOR_EXTENDED_GLOBAL_TIMEOUT, update_position=False,
                              callback=f"The '{package}' package .* from agent .* is vulnerable to '{cve}'",
                              error_message=f"Could not find the report which says that the package {package} is "
                                            f"vulnerable with {cve}")


def check_vulnerability_scan_discarded(wazuh_log_monitor, package):
    """Check if kernel packages are discarded by vulnerability detector.

    Args:
        wazuh_log_monitor (FileMonitor): FileMonitor object to monitor the Wazuh log
        package (str): Name of custom kernel package to check. Example: 'linux-image-aws'
    """
    check_vuln_detector_event(wazuh_log_monitor=wazuh_log_monitor, timeout=vd.VULN_DETECTOR_SCAN_TIMEOUT,
                              update_position=False, callback=f"Discarded Linux Kernel package '{package}' .*",
                              error_message=f"Could not find the report which says that the package {package} was "
                                            f"discarded",
                              prefix='.*')


def check_vulnerability_scan_alert(package, cve):
    """Check if inserted vulnerable packages are reported by vulnerability detector.
    Args:
        wazuh_alert_monitor (FileMonitor): FileMonitor object to monitor the Wazuh alerts log
        package (str): Name of custom package to check. Example: 'firefox-0'
        cve (str): Package CVE. Example: 'CVE-2019-11764'
    """
    check_vuln_detector_event(wazuh_log_monitor=FileMonitor(ALERT_FILE_PATH),
                              timeout=vd.VULN_DETECTOR_SCAN_TIMEOUT,
                              update_position=False, callback=f"{cve} affects {package}",
                              error_message=f"Could not find the report which says that {cve} affects the package "
                                            f"{package}",
                              prefix='.*')


def check_vulnerability_scan_remove_log(wazuh_log_monitor, package, cve):
    """Check if removed vulnerable packages are reported by vulnerability detector in yhe logs.
    Args:
        wazuh_log_monitor (FileMonitor): FileMonitor object to monitor the Wazuh log
        package (str): Name of custom package to check. Example: 'firefox-0'
        cve (str): Package CVE. Example: 'CVE-2019-11764'
    """
    check_vuln_detector_event(wazuh_log_monitor=wazuh_log_monitor, timeout=vd.VULN_DETECTOR_SCAN_TIMEOUT,
                              update_position=False, callback=f"The vulnerability '{cve}' affecting '{package}' was "
                                                              f"eliminated",
                              error_message=f"Could not find the log which says that the package {package} is no "
                                            f"longer vulnerable with {cve}")


def check_vulnerability_scan_remove_alerts(wazuh_alerts_monitor, package, cve):
    """Check if removed vulnerable packages are reported by vulnerability detector in the alerts.
    Args:
        wazuh_alerts_monitor (FileMonitor): FileMonitor object to monitor the Wazuh alerts log
        package (str): Name of custom package to check. Example: 'firefox-0'
        cve (str): Package CVE. Example: 'CVE-2019-11764'
    """
    check_vuln_detector_event(wazuh_log_monitor=wazuh_alerts_monitor, timeout=vd.VULN_DETECTOR_SCAN_TIMEOUT,
                              update_position=False, callback=f"The {cve} that affected {package} was eliminated due "
                                                              f"to a package removal/update or a system upgrade",
                              prefix='.*', error_message='Could not find the alert which says that the package '
                                                         f"{package} is no longer vulnerable with {cve}")


def check_provider_database_update_start_log(provider_name, timeout=vd.VULN_DETECTOR_FAST_TIMEOUT):
    """Check the provider database update start event in ossec.log

    Args:
        provider_name (str): Provider name of the downloaded feed.
        timeout (int): Timeout of the event.
    """
    check_vuln_detector_event(timeout=timeout,
                              callback=f"Starting '{provider_name}' database update",
                              error_message=f"Could not find {provider_name} update starting log")


def check_provider_database_update_finish_log(provider_name, timeout=vd.VULN_DETECTOR_GLOBAL_TIMEOUT):
    """Check the provider database update finish event in ossec.log

    Args:
        provider_name (str): Provider name of the downloaded feed.
        timeout (int): Timeout of the event.
    """
    check_vuln_detector_event(timeout=timeout,
                              callback=f"The update of the '{provider_name}' feed finished",
                              error_message=f"Could not find {provider_name} feed finished log")


def check_vulnerability_scan_remove_vuln_package(package, cve):
    """Check if removed vulnerable packages are reported by vulnerability detector in the log.

    Args:
        package (str): Name of custom package to check. Example: 'firefox-0'
        cve (str): Package CVE. Example: 'CVE-2019-11764'
    """
    check_vuln_detector_event(timeout=vd.VULN_DETECTOR_SCAN_TIMEOUT,
                              callback=f"Package '{package}' not vulnerable to '{cve}'.",
                              error_message='Could not find the alert which says that the package '
                              f"{package} is no longer vulnerable with {cve}")


def check_vulnerability_scan_inserted_package(package_name, package_cve):
    """Check if the package is inserted into its vulnerability.

    Args:
        package_name (str): Name of custom package to check.
        package_cve (str): Package CVE id.
    """
    check_vuln_detector_event(timeout=vd.VULN_DETECTOR_SCAN_TIMEOUT,
                              callback=f"Package '{package_name}' inserted into the vulnerability '{package_cve}'.",
                              error_message=f"No vulnerability for {package_name} package was detected in the log.")


def check_vulnerability_full_scan_start(min_full_scan_interval=0):
    """Check if a full scan event is reported by vulnerability detector in the logs.

    Args:
        min_full_scan_interval (int): Time set in the ossec.conf for min_full_scan_interval.
    """
    check_vuln_detector_event(timeout=vd.VULN_DETECTOR_SCAN_TIMEOUT+min_full_scan_interval,
                              callback="A full scan will be run on agent '000'",
                              error_message='No full scan start detected in log.')


def check_vulnerability_full_scan_end():
    """Check if the full scan end is reported by vulnerability detector in the logs."""
    check_vuln_detector_event(timeout=vd.VULN_DETECTOR_SCAN_TIMEOUT,
                              callback="Finished vulnerability assessment for agent '000'",
                              error_message='No full scan end has been detected in the log.')


def check_fetching_feed_log(feed_path):
    """Check the fetching feed file event in ossec.log

    Args:
        feed_path (str): Path of the feed to be fetched.
    """
    check_vuln_detector_event(timeout=vd.VULN_DETECTOR_GLOBAL_TIMEOUT,
                              callback=rf"Fetching .* from '{feed_path}'",
                              error_message=f"Could not find {feed_path} feed fetching log")


def check_refresh_feed_log(provider_name):
    """Check the inserting feed event in ossec.log

    Args:
        provider_name (str): Provider to be fetched.
    """
    check_vuln_detector_event(timeout=vd.VULN_DETECTOR_GLOBAL_TIMEOUT,
                              callback=f"Refresh of '{provider_name}' database finished",
                              error_message=f"Could not find {provider_name} feed refresh log")


def check_configuration_error():
    """Check the configuration error event in ossec.log"""
    check_vuln_detector_event(timeout=vd.DOWNLOAD_TIMEOUT,
                              callback=r".* \(\d+\): Configuration error at.*",
                              error_message=f"Could not find the event 'Configuration error at 'etc/ossec.conf' "
                                            'in ossec.log', prefix='.*wazuh-modulesd.*')


def check_invalid_option_log(provider_name):
    """Check the invalid option event in ossec.log

    Args:
        provider_name (str): Provider to be fetched.
    """
    check_vuln_detector_event(timeout=vd.DOWNLOAD_TIMEOUT,
                              callback=rf".*Invalid option 'os' for '{provider_name}' provider.*",
                              error_message=f"Could not find the event 'Configuration error at 'etc/ossec.conf' "
                                            'in ossec.log', prefix='.*wazuh-modulesd.*')


def check_retry_interval_log(seconds_number, num_expected_events=1):
    """Check the retry interval event in ossec.log

    Args:
        seconds_number (int): Number of seconds before retrying the vuln scan.
    """
    check_vuln_detector_event(timeout=vd.VULN_DETECTOR_GLOBAL_TIMEOUT, accum_results=num_expected_events,
                              callback=f"Going to sleep {seconds_number} seconds before retrying pending agents")


def check_analyzing_oval_vulnerabilities_log(agent_id='000'):
    """Check the analyzing oval vulnerabilities event in ossec.log

    Args:
        agent_id (str): Agent ID.
    """
    check_vuln_detector_event(timeout=vd.VULN_DETECTOR_GLOBAL_TIMEOUT,
                              callback=f"Analyzing OVAL vulnerabilities for agent '{agent_id}'")


def check_obtaining_software_failure_log(agent_id='000', num_attemps=5):
    """Check the obtaining software fail event in ossec.log

    Args:
        agent_id (str): Agent ID.
        num_attemps (int): Number of retry interval attemps.
    """
    check_vuln_detector_event(timeout=vd.VULN_DETECTOR_GLOBAL_TIMEOUT,
                              callback=f"The software of the agent '{agent_id}' could not be obtained after "
                                       f"{num_attemps} attempts. Skipping agent until the next scan.")


def check_nvd_download_log(update_year):
    """Check that the NVD download has started.

    Args:
        update_year (int): Year specified in <update_from_year>.
    """
    check_vuln_detector_event(
                timeout=vd.VULN_DETECTOR_SCAN_TIMEOUT,
                callback=fr".*Downloading .*nvdcve-\d.\d-{update_year}.meta.*",
                error_message='NVD feed download did not started',
                prefix=r'.*wazuh-modulesd:download.*'
            )


def check_nvd_download_completion(update_year):
    """Check that the NVD download has finished.

    Args:
        update_year (int): Year specified in <update_from_year>.
    """
    check_vuln_detector_event(
                timeout=vd.DOWNLOAD_TIMEOUT,
                callback=fr".*Download of 'https://nvd.nist.gov/feeds/json/cve/\d+.\d+/nvdcve-\d+.\d+-{update_year}"
                         r".json.gz' finished.*",
                error_message=f"The NVD feed from {update_year} did not finish",
                prefix=r'.*wazuh-modulesd:download.*'
            )


def check_invalid_provider_update_from_year_log(provider):
    """Check that the warning message is logged correctly.

    Args:
        provider (str): Provider name.
    """
    if provider == 'redhat':
        callback = "INFO: 'update_from_year' option at module 'vulnerability-detector' is deprecated"
    elif provider == 'msu':
        callback = "WARNING: 'update_from_year' option cannot be used for 'msu' provider."
    else:
        callback = f"WARNING: Invalid option 'update_from_year' for '{provider}' provider at 'vulnerability-detector'"

    check_vuln_detector_event(
                timeout=vd.VULN_DETECTOR_FAST_TIMEOUT,
                callback=callback,
                error_message="ERROR: Invalid content for 'update_from_year' option at module 'vulnerability-detector'",
                prefix=r".*"
            )
